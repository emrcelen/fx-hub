<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>FX Platform</title>

    <style>
        body {
            font-family: Arial;
            background: #f3f5f8;
            margin: 0;
            padding: 20px;
        }

        h2 {
            margin-bottom: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns:repeat(auto-fill, minmax(220px, 1fr));
            gap: 10px;
        }

        .card {
            background: #fff;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0, 0, 0, .08);
        }

        .price.up {
            color: green;
        }

        .price.down {
            color: red;
        }

        #log {
            background: #000;
            color: #0f0;
            font-size: 12px;
            height: 140px;
            overflow: auto;
            padding: 5px;
        }

        #subscribeLog {
            background: #f6f6f6;
            padding: 6px;
            border-left: 4px solid #007bff;
            margin-bottom: 8px;
            font-family: monospace;
        }

    </style>
</head>
<body>

<h2>ðŸ“¡ FX Rate Platform</h2>

<div class="grid" id="rates"></div>

<h3>Subscribe</h3>
<div id="subs"></div>

<h3>Log</h3>
<div id="subscribeLog" class="msg"></div>
<div id="log"></div>

<script>
    let socket;
    let rates = {};
    let subscribed = new Set();
    let subscribedPairs = new Set();

    function log(msg) {
        const d = document.createElement("div");
        d.innerText = msg;
        document.getElementById("log").appendChild(d);
        document.getElementById("log").scrollTop = 9999;
    }

    /* 1ï¸âƒ£ Snapshot al */
    async function reloadSnapshot() {
        const res = await fetch("http://localhost:8282/api/rates");
        const list = await res.json();

        list.forEach(r => {
            rates[r.pair] = r;
        });

        render();
    }
    async function loadSnapshot() {
        const res = await fetch("http://localhost:8282/api/rates");
        const list = await res.json();

        list.forEach(r => {
            rates[r.pair] = r;
        });

        render();
        renderCheckboxes(list.map(r => r.pair));
    }

    function connect() {
        socket = new WebSocket("ws://localhost:8282/ws/rates");

        socket.onopen = () => {
            log("WS CONNECTED");
            resubscribe();
        };

        socket.onmessage = e => {
            let data;
            try {
                data = JSON.parse(e.data);
                console.log(e.data)
                log("Message: " + e.data)
            } catch (err) {
                log("ðŸŸ¢ " + e.data);
                return;
            }
            rates[data.pair] = data;
            render();
        };

        socket.onclose = () => {
            log("WS CLOSED, reconnecting...");
            setTimeout(connect, 2000);
        };
    }

    function renderCheckboxes(pairs) {
        const div = document.getElementById("subs");
        div.innerHTML = "";

        pairs.forEach(p => {
            const label = document.createElement("label");
            label.innerHTML = `
            <input type="checkbox" value="${p}">
            ${p}
        `;
            label.querySelector("input").onchange = e => {
                if (e.target.checked) subscribed.add(p);
                else subscribed.delete(p);
                sendSubscribe();
            };
            div.appendChild(label);
            div.appendChild(document.createElement("br"));
        });
    }

    function sendSubscribe() {
        const checked = document.querySelectorAll("input[type=checkbox]:checked");
        const pairs = Array.from(checked).map(c => c.value);

        subscribedPairs = new Set(pairs);
        if (!socket || socket.readyState !== WebSocket.OPEN) return;
        socket.send(JSON.stringify({
            subscribe: Array.from(subscribed)
        }));
        updateSubscribeLog(pairs)
        reloadSnapshot()
        render()
    }

    function updateSubscribeLog(pairs) {
        const el = document.getElementById("subscribeLog");
        if (pairs.length === 0) {
            el.innerText = "SUBSCRIBE = (empty)";
        } else {
            el.innerText = "SUBSCRIBE = " + pairs.join(", ");
        }
    }

    function resubscribe() {
        if (subscribed.size > 0) sendSubscribe();
    }

    /* 5ï¸âƒ£ UI render */
    function render() {
        const div = document.getElementById("rates");
        div.innerHTML = "";

        subscribedPairs.forEach(pair => {
            const r = rates[pair];
            if (!r) return;

            const card = document.createElement("div");
            card.className = "card";
            card.innerHTML = `
            <b>${r.pair}</b>
            <div>Bid: <b>${r.bid}</b></div>
            <div>Ask: <b>${r.ask}</b></div>
        `;
            div.appendChild(card);
        });
    }

    /* INIT */
    loadSnapshot();
    connect();
</script>

</body>
</html>
